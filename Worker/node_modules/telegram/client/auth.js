"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.authFlow = exports.signInBot = exports.signInWithPassword = exports.sendCode = exports.signInUserWithQrCode = exports.signInUser = exports.checkAuthorization = exports.start = void 0;
const tl_1 = require("../tl");
const utils = __importStar(require("../Utils"));
const Helpers_1 = require("../Helpers");
const Password_1 = require("../Password");
const QR_CODE_TIMEOUT = 30000;
// region public methods
function start(client, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!client.connected) {
            yield client.connect();
        }
        if (yield client.checkAuthorization()) {
            return;
        }
        const apiCredentials = {
            apiId: client.apiId,
            apiHash: client.apiHash,
        };
        yield client.authFlow(apiCredentials, authParams);
    });
}
exports.start = start;
function checkAuthorization(client) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            yield client.invoke(new tl_1.Api.updates.GetState());
            return true;
        }
        catch (e) {
            return false;
        }
    });
}
exports.checkAuthorization = checkAuthorization;
function signInUser(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        let phoneNumber;
        let phoneCodeHash;
        let isCodeViaApp = false;
        while (1) {
            try {
                if (typeof authParams.phoneNumber === 'function') {
                    try {
                        phoneNumber = yield authParams.phoneNumber();
                    }
                    catch (err) {
                        if (err.message === 'RESTART_AUTH_WITH_QR') {
                            return client.signInUserWithQrCode(apiCredentials, authParams);
                        }
                        throw err;
                    }
                }
                else {
                    phoneNumber = authParams.phoneNumber;
                }
                const sendCodeResult = yield client.sendCode(apiCredentials, phoneNumber, authParams.forceSMS);
                phoneCodeHash = sendCodeResult.phoneCodeHash;
                isCodeViaApp = sendCodeResult.isCodeViaApp;
                if (typeof phoneCodeHash !== 'string') {
                    throw new Error('Failed to retrieve phone code hash');
                }
                break;
            }
            catch (err) {
                if (typeof authParams.phoneNumber !== 'function') {
                    throw err;
                }
                authParams.onError(err);
            }
        }
        let phoneCode;
        let isRegistrationRequired = false;
        let termsOfService;
        while (1) {
            try {
                try {
                    phoneCode = yield authParams.phoneCode(isCodeViaApp);
                }
                catch (err) {
                    // This is the support for changing phone number from the phone code screen.
                    if (err.message === 'RESTART_AUTH') {
                        return client.signInUser(apiCredentials, authParams);
                    }
                }
                if (!phoneCode) {
                    throw new Error('Code is empty');
                }
                // May raise PhoneCodeEmptyError, PhoneCodeExpiredError,
                // PhoneCodeHashEmptyError or PhoneCodeInvalidError.
                const result = yield client.invoke(new tl_1.Api.auth.SignIn({
                    phoneNumber,
                    phoneCodeHash,
                    phoneCode,
                }));
                if (result instanceof tl_1.Api.auth.AuthorizationSignUpRequired) {
                    isRegistrationRequired = true;
                    termsOfService = result.termsOfService;
                    break;
                }
                return result.user;
            }
            catch (err) {
                if (err.message === 'SESSION_PASSWORD_NEEDED') {
                    return client.signInWithPassword(apiCredentials, authParams);
                }
                else {
                    authParams.onError(err);
                }
            }
        }
        if (isRegistrationRequired) {
            while (1) {
                try {
                    let lastName;
                    let firstName = "first name";
                    if (authParams.firstAndLastNames) {
                        const result = yield authParams.firstAndLastNames();
                        firstName = result[0];
                        lastName = result[1];
                    }
                    if (!firstName) {
                        throw new Error('First name is required');
                    }
                    const { user } = yield client.invoke(new tl_1.Api.auth.SignUp({
                        phoneNumber,
                        phoneCodeHash,
                        firstName,
                        lastName,
                    }));
                    if (termsOfService) {
                        // This is a violation of Telegram rules: the user should be presented with and accept TOS.
                        yield client.invoke(new tl_1.Api.help.AcceptTermsOfService({ id: termsOfService.id }));
                    }
                    return user;
                }
                catch (err) {
                    authParams.onError(err);
                }
            }
        }
        authParams.onError(new Error('Auth failed'));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUser = signInUser;
function signInUserWithQrCode(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const inputPromise = (() => __awaiter(this, void 0, void 0, function* () {
            while (1) {
                const result = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                    apiId: Number(process.env.TELEGRAM_T_API_ID),
                    apiHash: process.env.TELEGRAM_T_API_HASH,
                    exceptIds: [],
                }));
                if (!(result instanceof tl_1.Api.auth.LoginToken)) {
                    throw new Error('Unexpected');
                }
                const { token, expires } = result;
                if (authParams.qrCode) {
                    yield Promise.race([
                        authParams.qrCode({ token, expires }),
                        Helpers_1.sleep(QR_CODE_TIMEOUT),
                    ]);
                }
            }
        }))();
        const updatePromise = new Promise((resolve) => {
            client.addEventHandler((update) => {
                if (update instanceof tl_1.Api.UpdateLoginToken) {
                    resolve(undefined);
                }
            });
        });
        try {
            yield Promise.race([updatePromise, inputPromise]);
        }
        catch (err) {
            if (err.message === 'RESTART_AUTH') {
                return client.signInUser(apiCredentials, authParams);
            }
            throw err;
        }
        try {
            const result2 = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                apiId: Number(process.env.TELEGRAM_T_API_ID),
                apiHash: process.env.TELEGRAM_T_API_HASH,
                exceptIds: [],
            }));
            if (result2 instanceof tl_1.Api.auth.LoginTokenSuccess && result2.authorization instanceof tl_1.Api.auth.Authorization) {
                return result2.authorization.user;
            }
            else if (result2 instanceof tl_1.Api.auth.LoginTokenMigrateTo) {
                yield client._switchDC(result2.dcId);
                const migratedResult = yield client.invoke(new tl_1.Api.auth.ImportLoginToken({
                    token: result2.token,
                }));
                if (migratedResult instanceof tl_1.Api.auth.LoginTokenSuccess && migratedResult.authorization instanceof tl_1.Api.auth.Authorization) {
                    return migratedResult.authorization.user;
                }
            }
        }
        catch (err) {
            if (err.message === 'SESSION_PASSWORD_NEEDED') {
                return client.signInWithPassword(apiCredentials, authParams);
            }
        }
        authParams.onError(new Error('QR auth failed'));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUserWithQrCode = signInUserWithQrCode;
function sendCode(client, apiCredentials, phoneNumber, forceSMS = false) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const { apiId, apiHash } = apiCredentials;
            const sendResult = yield client.invoke(new tl_1.Api.auth.SendCode({
                phoneNumber,
                apiId,
                apiHash,
                settings: new tl_1.Api.CodeSettings(),
            }));
            // If we already sent a SMS, do not resend the phoneCode (hash may be empty)
            if (!forceSMS || (sendResult.type instanceof tl_1.Api.auth.SentCodeTypeSms)) {
                return {
                    phoneCodeHash: sendResult.phoneCodeHash,
                    isCodeViaApp: sendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
                };
            }
            const resendResult = yield client.invoke(new tl_1.Api.auth.ResendCode({
                phoneNumber,
                phoneCodeHash: sendResult.phoneCodeHash,
            }));
            return {
                phoneCodeHash: resendResult.phoneCodeHash,
                isCodeViaApp: resendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
            };
        }
        catch (err) {
            if (err.message === 'AUTH_RESTART') {
                return client.sendCode(apiCredentials, phoneNumber, forceSMS);
            }
            else {
                throw err;
            }
        }
    });
}
exports.sendCode = sendCode;
function signInWithPassword(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        while (1) {
            try {
                const passwordSrpResult = yield client.invoke(new tl_1.Api.account.GetPassword());
                const password = yield authParams.password(passwordSrpResult.hint);
                if (!password) {
                    throw new Error('Password is empty');
                }
                const passwordSrpCheck = yield Password_1.computeCheck(passwordSrpResult, password);
                const { user } = yield client.invoke(new tl_1.Api.auth.CheckPassword({
                    password: passwordSrpCheck,
                }));
                return user;
            }
            catch (err) {
                authParams.onError(err);
            }
        }
        return undefined; // Never reached (TypeScript fix)
    });
}
exports.signInWithPassword = signInWithPassword;
function signInBot(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const { apiId, apiHash } = apiCredentials;
        let { botAuthToken } = authParams;
        if (!botAuthToken) {
            throw new Error('a valid BotToken is required');
        }
        if (typeof botAuthToken === "function") {
            let token;
            while (true) {
                token = yield botAuthToken();
                if (token) {
                    botAuthToken = token;
                    break;
                }
            }
        }
        const { user } = yield client.invoke(new tl_1.Api.auth.ImportBotAuthorization({
            apiId,
            apiHash,
            botAuthToken,
        }));
        return user;
    });
}
exports.signInBot = signInBot;
function authFlow(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const me = 'phoneNumber' in authParams
            ? yield client.signInUser(apiCredentials, authParams)
            : yield client.signInBot(apiCredentials, authParams);
        // TODO @logger
        client._log.info('Signed in successfully as ' + utils.getDisplayName(me));
    });
}
exports.authFlow = authFlow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyYW1qcy9jbGllbnQvYXV0aC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsOEJBQTBCO0FBQzFCLGdEQUFrQztBQUNsQyx3Q0FBaUM7QUFDakMsMENBQW9FO0FBMEJwRSxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUM7QUFHOUIsd0JBQXdCO0FBRXhCLFNBQXNCLEtBQUssQ0FBQyxNQUFzQixFQUFFLFVBQTBDOztRQUMxRixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtZQUNuQixNQUFNLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUMxQjtRQUVELElBQUksTUFBTSxNQUFNLENBQUMsa0JBQWtCLEVBQUUsRUFBRTtZQUNuQyxPQUFPO1NBQ1Y7UUFFRCxNQUFNLGNBQWMsR0FBRztZQUNuQixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7WUFDbkIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO1NBQzFCLENBQUM7UUFFRixNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Q0FBQTtBQWZELHNCQWVDO0FBRUQsU0FBc0Isa0JBQWtCLENBQUMsTUFBc0I7O1FBQzNELElBQUk7WUFDQSxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxRQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDaEQsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsT0FBTyxLQUFLLENBQUM7U0FDaEI7SUFDTCxDQUFDO0NBQUE7QUFQRCxnREFPQztBQUVELFNBQXNCLFVBQVUsQ0FDNUIsTUFBc0IsRUFDdEIsY0FBOEIsRUFDOUIsVUFBMEI7O1FBRTFCLElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUksYUFBYSxDQUFDO1FB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